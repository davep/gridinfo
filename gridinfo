#!/usr/bin/env python
"""A tool for getting information about the Second Life grid."""

##############################################################################
# Python imports.
from urllib.parse import quote
from tempfile     import NamedTemporaryFile

##############################################################################
# HTTPX imports.
import httpx

##############################################################################
# Textual imports.
from textual.app        import App, ComposeResult
from textual.binding    import Binding
from textual.css.query  import NoMatches
from textual.widgets    import Header, Footer, Input, Button, Static, Label
from textual.containers import Container, Horizontal

##############################################################################
# Rich Pixels imports.
from rich_pixels import Pixels

##############################################################################
async def get( url: str ) -> httpx.Response:
    """Get a response from a URL.

    Args:
        url (str): The URL to get a response from.

    Returns:
        httpx.Response: The response.
    """
    async with httpx.AsyncClient() as client:
        return await client.get( url, follow_redirects=True )

##############################################################################
def gridsurvey( query: str ) -> str:
    """Return the URL for the given Grid Survey query.

    Args:
        query (str): The query to make.

    Returns:
        str: The full URL for the query.
    """
    return f"http://api.gridsurvey.com/{query}"

##############################################################################
async def region_info( region: str ) -> dict[ str, str ]:
    """Get information about a given region.

    Args:
        region (str): The region to get the information for.

    Returns:
        dict[ str, str ]: The data for that region.
    """
    info = await get( gridsurvey( f"simquery.php?region={quote( region )}" ) )
    return dict( line.split() for line in info.text.split( "\n" ) )

##############################################################################
async def region_map( map_uuid: str, size: int=40 ) -> Pixels:
    """Given a map UUID, get the texture.

    Args:
        map_uuid (str): The UUID of the map to acquire.
        size (int, optional): The size of a side of the resulting map tile.

    Returns:
        Pixels: The ``Pixel`` image.
    """
    with NamedTemporaryFile() as img:
        map_data = await get( f"http://secondlife.com/app/image/{map_uuid}/2" )
        img.write( map_data.content )
        return Pixels.from_image_path( img.name, resize=( size, size ) )

##############################################################################
class GridInfo( App[ None ] ):
    """TUI app for showing information about the Second Life grid."""

    CSS_PATH = "gridinfo.css"
    """The name of the CSS file for the app."""

    TITLE = "Grid Information"
    """str: The title of the application."""

    BINDINGS = [
        Binding( "q", "quit", "Quit" )
    ]
    """The main bindings for the app."""

    def compose( self ) -> ComposeResult:
        """Compose the display of the application.

        Returns:
            ComposeResult: The main layout for the application.
        """

        yield Header()

        yield Horizontal(
            Input( placeholder="Second Life Region Name" ),
            Button( "Search", disabled=True ),
            id="region-input"
        )

        def _data( label: str, value_id: str ) -> Horizontal:
            return Horizontal( Label( f"{label}:", classes="title" ), Label( id=value_id ) )

        yield Container(
            _data( "Name", "name" ),
            _data( "Status", "status" ),
            _data( "X", "x" ),
            _data( "Y", "y" ),
            _data( "Access", "access" ),
            _data( "Estate", "estate" ),
            _data( "First Seen", "firstseen" ),
            _data( "Last Seen", "lastseen" ),
            _data( "Objects Map", "objects_uuid" ),
            _data( "Terrain Map", "terrain_uuid" ),
            _data( "Updated", "updated" ),
            _data( "UUID", "region_uuid" ),
            id="data"
        )

        yield Static( id="map" )

        yield Footer()

    def on_mount( self ) -> None:
        """Set the app up once the DOM is loaded."""
        self.set_focus( self.query_one( "#region-input Input", Input ) )

    def on_input_changed( self, event: Input.Changed ) -> None:
        """React to the region name being modified.

        Args:
            event (Input.Changed): The event for the change.
        """
        self.query_one(
            "#region-input Button", Button
        ).disabled = not bool( event.input.value.strip() )

    async def update_region_data( self ) -> None:
        """Update the region data."""
        data = await region_info( self.query_one( Input ).value )
        print( data )
        for key, value in data.items():
            try:
                self.query_one( f"#{key}", Label ).update( value )
            except NoMatches:
                pass
        map = self.query_one( "#map", Static )
        map.update( await region_map( data[ "objects_uuid" ], map.size.width ) )

    async def on_input_submitted( self, _: Input.Submitted ) -> None:
        """React to input being submitted.

        Args:
            event (Input.Submitted): The even for the submit.
        """
        await self.update_region_data()

    async def on_button_pressed( self, _: Button.Pressed ) -> None:
        """React to the search button being pressed.

        Args:
            event (Button.Pressed): The event for the press.
        """
        await self.update_region_data()

##############################################################################
# Main entry point.
if __name__ == "__main__":
    GridInfo().run()

### gridinfo.py ends here
